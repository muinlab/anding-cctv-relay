<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Seat Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .store-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .store-selector label {
            font-weight: 600;
            font-size: 16px;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:hover {
            border-color: #667eea;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #757575;
            font-weight: 500;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .stat-card.occupied .stat-value {
            color: #f44336;
        }

        .stat-card.empty .stat-value {
            color: #4caf50;
        }

        .stat-card.abandoned .stat-value {
            color: #ff9800;
        }

        .stat-card.rate .stat-value {
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .seat-grid {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .seat-grid h2 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }

        .seat-item {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 10px;
        }

        .seat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .seat-item.empty {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .seat-item.occupied {
            background: #ffebee;
            border-color: #f44336;
        }

        .seat-item.abandoned {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .seat-id {
            font-weight: 700;
            font-size: 14px;
        }

        .seat-item.empty .seat-id {
            color: #2e7d32;
        }

        .seat-item.occupied .seat-id {
            color: #c62828;
        }

        .seat-item.abandoned .seat-id {
            color: #e65100;
        }

        .seat-status {
            font-size: 10px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .events-panel {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }

        .events-panel h2 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .event-item {
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .event-item.person_enter {
            border-left: 4px solid #f44336;
        }

        .event-item.person_leave {
            border-left: 4px solid #4caf50;
        }

        .event-item.abandoned_detected {
            border-left: 4px solid #ff9800;
        }

        .event-time {
            font-size: 11px;
            color: #757575;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #757575;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .auto-refresh input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .legend {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .legend h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid;
        }

        .legend-color.empty {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .legend-color.occupied {
            background: #ffebee;
            border-color: #f44336;
        }

        .legend-color.abandoned {
            background: #fff3e0;
            border-color: #ff9800;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• CCTV Seat Monitoring Dashboard</h1>
            <div class="subtitle">Real-time Seat Occupancy Tracking</div>
        </header>

        <div class="store-selector">
            <label>üìç Select Store:</label>
            <select id="storeSelect" onchange="loadStore()">
                <option value="">Loading stores...</option>
            </select>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh</button>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                <label for="autoRefresh">Auto-refresh (10s)</label>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card occupied">
                <div class="stat-label">Occupied Seats</div>
                <div class="stat-value" id="occupiedCount">-</div>
            </div>
            <div class="stat-card empty">
                <div class="stat-label">Empty Seats</div>
                <div class="stat-value" id="emptyCount">-</div>
            </div>
            <div class="stat-card abandoned">
                <div class="stat-label">Abandoned Items</div>
                <div class="stat-value" id="abandonedCount">-</div>
            </div>
            <div class="stat-card rate">
                <div class="stat-label">Occupancy Rate</div>
                <div class="stat-value" id="occupancyRate">-</div>
            </div>
        </div>

        <div class="main-content">
            <div class="seat-grid">
                <h2>ü™ë Seat Status</h2>
                <div class="grid-container" id="seatGrid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Select a store to view seat status</p>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="legend">
                    <h3>Legend</h3>
                    <div class="legend-item">
                        <div class="legend-color empty"></div>
                        <span>Empty Seat</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color occupied"></div>
                        <span>Occupied Seat</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color abandoned"></div>
                        <span>Abandoned Item</span>
                    </div>
                </div>

                <div class="events-panel">
                    <h2>üìã Recent Events</h2>
                    <div id="eventsList">
                        <div class="loading">
                            <p>No events yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStore = null;
        let autoRefreshInterval = null;

        // Initialize
        window.onload = function() {
            loadStores();
        };

        // Load available stores
        async function loadStores() {
            try {
                const response = await fetch('http://localhost:8001/api/stores');
                const stores = await response.json();

                const select = document.getElementById('storeSelect');
                select.innerHTML = '<option value="">-- Select Store --</option>';

                stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.store_id;
                    option.textContent = store.store_name;
                    select.appendChild(option);
                });

                // Auto-select first store if available
                if (stores.length > 0) {
                    select.value = stores[0].store_id;
                    loadStore();
                }
            } catch (error) {
                console.error('Failed to load stores:', error);
                alert('Failed to load stores. Make sure the API server is running on port 8001.');
            }
        }

        // Load store data
        async function loadStore() {
            const storeId = document.getElementById('storeSelect').value;
            if (!storeId) return;

            currentStore = storeId;
            await refreshData();
        }

        // Refresh data
        async function refreshData() {
            if (!currentStore) return;

            await Promise.all([
                loadSummary(),
                loadSeatStatus(),
                loadEvents()
            ]);
        }

        // Load summary statistics
        async function loadSummary() {
            try {
                const response = await fetch(`http://localhost:8001/api/stores/${currentStore}/summary`);
                const summary = await response.json();

                document.getElementById('occupiedCount').textContent = summary.occupied_count;
                document.getElementById('emptyCount').textContent = summary.empty_count;
                document.getElementById('abandonedCount').textContent = summary.abandoned_count || 0;
                document.getElementById('occupancyRate').textContent = (summary.occupancy_rate * 100).toFixed(1) + '%';
            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }

        // Load seat status
        async function loadSeatStatus() {
            try {
                const response = await fetch(`http://localhost:8001/api/stores/${currentStore}/status`);
                const statuses = await response.json();

                const grid = document.getElementById('seatGrid');
                grid.innerHTML = '';

                if (statuses.length === 0) {
                    grid.innerHTML = '<div class="loading"><p>No seats configured for this store</p></div>';
                    return;
                }

                statuses.forEach(seat => {
                    const div = document.createElement('div');
                    div.className = `seat-item ${seat.status}`;
                    div.title = `${seat.seat_id} - ${seat.status}\nVacant: ${seat.vacant_duration_seconds}s`;
                    div.onclick = () => showSeatDetails(seat);

                    const statusText = seat.status === 'occupied' ? 'üßë' :
                                     seat.status === 'abandoned' ? 'üì¶' :
                                     '‚úì';

                    div.innerHTML = `
                        <div class="seat-id">${seat.seat_id}</div>
                        <div class="seat-status">${statusText}</div>
                    `;

                    grid.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load seat status:', error);
            }
        }

        // Load recent events
        async function loadEvents() {
            try {
                const response = await fetch(`http://localhost:8001/api/stores/${currentStore}/events?limit=20`);
                const events = await response.json();

                const list = document.getElementById('eventsList');
                list.innerHTML = '';

                if (events.length === 0) {
                    list.innerHTML = '<div class="loading"><p>No events yet</p></div>';
                    return;
                }

                events.forEach(event => {
                    const div = document.createElement('div');
                    div.className = `event-item ${event.event_type}`;

                    const eventLabel = {
                        'person_enter': 'üü• Person Entered',
                        'person_leave': 'üü© Person Left',
                        'abandoned_detected': 'üüß Item Abandoned'
                    }[event.event_type] || event.event_type;

                    const time = new Date(event.created_at).toLocaleTimeString();

                    div.innerHTML = `
                        <strong>${event.seat_id}</strong> - ${eventLabel}
                        <div class="event-time">${time} (Conf: ${(event.confidence * 100).toFixed(0)}%)</div>
                    `;

                    list.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load events:', error);
            }
        }

        // Show seat details (popup or modal)
        function showSeatDetails(seat) {
            const lastPersonTime = seat.last_person_seen
                ? new Date(seat.last_person_seen).toLocaleString()
                : 'Never';

            const lastEmptyTime = seat.last_empty_time
                ? new Date(seat.last_empty_time).toLocaleString()
                : 'Never';

            const vacantDuration = Math.floor(seat.vacant_duration_seconds / 60);

            alert(`
Seat: ${seat.seat_id}
Status: ${seat.status.toUpperCase()}

Person Detected: ${seat.person_detected ? 'Yes' : 'No'}
Object Detected: ${seat.object_detected ? 'Yes' : 'No'}
Confidence: ${seat.detection_confidence ? (seat.detection_confidence * 100).toFixed(1) + '%' : 'N/A'}

Last Person Seen: ${lastPersonTime}
Last Empty Time: ${lastEmptyTime}
Vacant Duration: ${vacantDuration} minutes

Updated: ${new Date(seat.updated_at).toLocaleString()}
            `.trim());
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const enabled = document.getElementById('autoRefresh').checked;

            if (enabled) {
                autoRefreshInterval = setInterval(refreshData, 10000); // 10 seconds
                console.log('Auto-refresh enabled (10s interval)');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('Auto-refresh disabled');
            }
        }
    </script>
</body>
</html>
