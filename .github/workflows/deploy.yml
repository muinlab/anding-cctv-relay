name: Deploy to CCTV Relay Servers

on:
  push:
    branches:
      - deploy

jobs:
  deploy-oryudong:
    name: Deploy to 오류동역점
    runs-on: [self-hosted, oryudong]
    env:
      STORE_ID: oryudong
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      DEBUG_STREAM_ENABLED: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate go2rtc config from Supabase
        run: ./scripts/generate-go2rtc-config.sh

      - name: Restart go2rtc
        run: |
          docker compose down go2rtc || true
          docker compose up -d go2rtc

      - name: Health check go2rtc
        run: |
          sleep 5
          curl -sf http://localhost:1984/api || exit 1
          echo "go2rtc is healthy"

      - name: Build and start cctv-worker
        run: |
          docker compose build cctv-worker
          docker compose up -d cctv-worker

      - name: Health check cctv-worker
        run: |
          sleep 30
          docker compose ps cctv-worker

      - name: Show status
        run: |
          echo "=== Container Status ==="
          docker compose ps
          echo ""
          echo "=== Available Streams ==="
          curl -s http://localhost:1984/api/streams | jq 'keys'
          echo ""
          echo "=== cctv-worker logs ==="
          docker compose logs --tail=20 cctv-worker
